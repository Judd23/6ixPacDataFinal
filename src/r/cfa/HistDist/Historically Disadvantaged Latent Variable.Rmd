---
title: "Student Background Latent Variable"
output: html_document
date: "2025-11-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
```

```{r}
library(psych)
library(lavaan)
library(semTools)
library(GPArotation)
library(dplyr)
library(ggplot2)

data_path <- file.path("data", "clean", "OfficialDataset_Final.csv")
if (!file.exists(data_path)) {
	stop("Missing clean dataset at ", data_path)
}
data <- read.csv(data_path)


have_semTools <- requireNamespace("semTools", quietly = TRUE)

model <-'
# measurement model
 HistDisadv =~ FirstGen_RC + UndrRepStud_RC + 
                   FINCON_RC + INCOME + CITIZEN


# (residual) (co)variances
 HistDisadv ~~ HistDisadv'

## Prepare indicators as ordered (categorical) and fit with WLSMV
inds <- c("FirstGen_RC", "UndrRepStud_RC", "FINCON_RC", "INCOME", "CITIZEN")
data2 <- data
for (v in inds) {
	if (v %in% names(data2)) {
		# coerce to integer where possible, keep NAs
		data2[[v]] <- ifelse(is.na(data2[[v]]), NA, as.integer(data2[[v]]))
		# treat as ordered (lavaan will handle binary/ordinal)
		data2[[v]] <- ordered(data2[[v]])
	}
}

# Fit with WLSMV for categorical indicators; fallback to ML if it errors
result <- tryCatch(
	lavaan::cfa(model, data = data2, ordered = intersect(inds, names(data2)), estimator = "WLSMV", missing = "pairwise"),
	error = function(e) {
		message('WLSMV failed; falling back to ML with FIML: ', e$message)
		lavaan::lavaan(model, data = data, meanstructure = TRUE,
									 estimator = "ML", missing = "fiml",
									 auto.fix.first = TRUE, auto.fix.single = TRUE,
									 auto.var = TRUE, auto.cov.lv.x = TRUE, auto.cov.y = TRUE,
									 fixed.x = TRUE)
	}
)


message("\n--- Model Summary ---")
print(summary(result, result.measures = TRUE, standardized = TRUE))
message("\n--- Fit Measures (key indices) ---")
print(fitMeasures(result, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper", "srmr")))
message("\n--- Parameter Estimates (loadings) ---")
pe <- parameterEstimates(result, standardized = TRUE)
loadings <- subset(pe, op == "=~", select = c(lhs, rhs, est, se, z, pvalue, std.all))
print(loadings)
message("\n--- Residual Variances ---")
resid_vars <- subset(pe, op == "~~" & lhs %in% model & lhs == rhs, select = c(lhs, est, se, z, pvalue))
print(resid_vars)
message("\n--- R-squared ---")
print(inspect(result, "r2"))
if (have_semTools) {
message("\n--- Reliability (semTools::reliability) ---")
print(semTools::reliability(result))
message("\n--- Average Variance Extracted (semTools::AVE) ---")
print(semTools::AVE(result))
} else {
message("\n(Note: Install 'semTools' to obtain reliability/AVE.)")
}
message("\n=== End of CFA report ===")

```

